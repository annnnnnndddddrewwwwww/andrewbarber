<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Salón de Belleza - Sistema de Reservas</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800&family=Playfair+Display:wght@700;800&display=swap" rel="stylesheet">
    <script src="https://www.paypal.com/sdk/js?client-id=AcHVDv1aIL8zXveIKKXRdXr6AR6NHLrlxHhPnzH1IaEWvWPqVrWL8JY2FB0JGMolSAZJAMczs5PRKcHa&currency=EUR" data-sdk-integration-source="button-factory"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #ff6b9d 0%, #c471ed 50%, #12c2e9 100%);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        /* ===== PANTALLA DE CARGA (UNCHANGED) ===== */
        #loadingScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #ff6b9d 0%, #c471ed 50%, #12c2e9 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.6s ease, visibility 0.6s ease;
        }

            #loadingScreen.hidden {
                opacity: 0;
                visibility: hidden;
            }

        .loading-content {
            text-align: center;
            animation: fadeInScale 0.8s ease-out;
        }

        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.9);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .loading-logo {
            font-size: 120px;
            margin-bottom: 30px;
            filter: drop-shadow(0 20px 40px rgba(0, 0, 0, 0.3));
            animation: floatLogo 3s ease-in-out infinite;
        }

        @keyframes floatLogo {
            0%, 100% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-20px);
            }
        }

        .loading-spinner {
            width: 70px;
            height: 70px;
            margin: 0 auto 25px;
            position: relative;
        }

        .spinner-ring {
            position: absolute;
            width: 100%;
            height: 100%;
            border: 4px solid transparent;
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s cubic-bezier(0.5, 0, 0.5, 1) infinite;
        }

            .spinner-ring:nth-child(1) {
                animation-delay: -0.45s;
            }

            .spinner-ring:nth-child(2) {
                animation-delay: -0.3s;
                border-top-color: rgba(255, 255, 255, 0.6);
            }

            .spinner-ring:nth-child(3) {
                animation-delay: -0.15s;
                border-top-color: rgba(255, 255, 255, 0.3);
            }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .loading-text {
            color: white;
            font-size: 26px;
            font-weight: 700;
            margin-bottom: 12px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .loading-subtext {
            color: rgba(255, 255, 255, 0.9);
            font-size: 16px;
            font-weight: 400;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }

            50% {
                opacity: 0.6;
            }
        }

        .loading-dots::after {
            content: '';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% {
                content: '';
            }

            40% {
                content: '.';
            }

            60% {
                content: '..';
            }

            80%, 100% {
                content: '...';
            }
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 20% 50%, rgba(255, 107, 157, 0.3) 0%, transparent 50%);
            animation: gradientShift 15s ease infinite;
        }

        @keyframes gradientShift {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }

            50% {
                opacity: 0.8;
                transform: scale(1.1);
            }
        }

        .orb {
            position: fixed;
            border-radius: 50%;
            filter: blur(100px);
            opacity: 0.5;
            animation: floatOrb 20s infinite ease-in-out;
            pointer-events: none;
        }

        .orb1 {
            width: 600px;
            height: 600px;
            background: radial-gradient(circle, #ff6b9d, #c471ed);
            top: -200px;
            left: -200px;
        }

        .orb2 {
            width: 500px;
            height: 500px;
            background: radial-gradient(circle, #4facfe, #00f2fe);
            bottom: -150px;
            right: -150px;
            animation-delay: 7s;
        }

        .orb3 {
            width: 450px;
            height: 450px;
            background: radial-gradient(circle, #f093fb, #f5576c);
            top: 50%;
            left: 50%;
            animation-delay: 14s;
        }

        @keyframes floatOrb {
            0%, 100% {
                transform: translate(0, 0) scale(1);
            }

            33% {
                transform: translate(100px, -100px) scale(1.2);
            }

            66% {
                transform: translate(-80px, 80px) scale(0.8);
            }
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 60px 20px;
            position: relative;
            z-index: 10;
        }

        .header {
            text-align: center;
            margin-bottom: 60px;
            animation: fadeInDown 1.2s ease-out;
        }

        .logo-img {
            font-size: 100px;
            animation: gentleFloat 5s ease-in-out infinite;
            margin-bottom: 20px;
        }

        @keyframes gentleFloat {
            0%, 100% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-15px);
            }
        }

        h1 {
            font-family: 'Playfair Display', serif;
            font-size: 54px;
            font-weight: 800;
            color: white;
            margin-bottom: 15px;
            text-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            letter-spacing: -1px;
        }

        .subtitle {
            font-size: 20px;
            color: rgba(255, 255, 255, 0.95);
            font-weight: 300;
        }

        /* La definición de .glass-card se moverá a la parte inferior para usar la versión mejorada */
        /* .glass-card {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(30px) saturate(180%);
            border-radius: 40px;
            padding: 50px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            border: 1px solid rgba(255, 255, 255, 0.3);
            animation: fadeInUp 1s ease-out;
            position: relative;
            overflow: hidden;
        } */

        /* AUTH SCREENS */
        .auth-container {
            max-width: 500px;
            margin: 0 auto;
        }

        .auth-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 40px;
        }

        .auth-tab {
            flex: 1;
            padding: 18px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            color: white;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }

            .auth-tab.active {
                background: rgba(255, 255, 255, 0.9);
                color: #ff6b9d;
                border-color: white;
            }

        .input-group {
            position: relative;
            margin-bottom: 20px;
        }

        .input-icon {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            /* La versión mejorada de abajo sobreescribirá este font-size y z-index:2 */
            font-size: 20px;
            z-index: 2;
        }

        /* MODIFICADO: Estilos originales de input, select (serán sobreescritos por los nuevos si son más específicos) */
        input, select {
            width: 100%;
            padding: 18px 20px 18px 55px;
            background: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.4);
            border-radius: 15px;
            color: white;
            font-size: 16px;
            transition: all 0.3s;
            outline: none;
            font-weight: 500;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
        }

        select {
            padding-right: 20px;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 15px center;
            background-size: 18px;
        }

        input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        input:focus, select:focus {
            border-color: white;
            background: rgba(255, 255, 255, 0.4);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        /* El estilo original de .btn-primary será reemplazado por la versión mejorada que está más abajo */
        /* .btn-primary {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #ff6b9d, #c471ed);
            border: none;
            border-radius: 15px;
            color: white;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 10px 30px rgba(255, 107, 157, 0.4);
        }

            .btn-primary:hover {
                transform: translateY(-3px);
                box-shadow: 0 15px 40px rgba(255, 107, 157, 0.6);
            }

            .btn-primary:disabled {
                opacity: 0.5;
                cursor: not-allowed;
                transform: none;
                box-shadow: none;
            } */

        /* USER NAV */
        .user-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            color: white;
            font-weight: 600;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #ff6b9d, #c471ed);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
        }

        .btn-nav {
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.3);
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-radius: 12px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

            .btn-nav:hover {
                background: rgba(255, 255, 255, 0.5);
            }

            .btn-nav.active {
                background: rgba(255, 255, 255, 0.9);
                color: #c471ed;
            }

        /* RESERVATION CARD LIST */
        .appointment-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .appointment-card {
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            padding: 20px;
            color: white;
            transition: transform 0.3s, box-shadow 0.3s;
            cursor: default;
        }

            .appointment-card:hover {
                transform: translateY(-5px);
                box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            }

        .appointment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .appointment-service {
            font-size: 20px;
            font-weight: 700;
        }

        .appointment-status {
            padding: 5px 10px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 600;
        }

        /* Modificado: Colores de estado */
        .status-confirmed {
            background-color: #38a169; /* Verde para Completado */
            color: white;
        }

        .status-pending {
            background-color: #f6ad55; /* Naranja para Pendiente */
            color: white;
        }

        .appointment-details {
            font-size: 14px;
            line-height: 1.8;
            color: rgba(255, 255, 255, 0.8);
        }

        /* La definición original de payment-options-group y sus sub-elementos será reemplazada por las versiones mejoradas */
        /* NEW STYLES: Payment Selection (Originals) */
        /*
        .payment-options-group {
            margin-top: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 15px;
        }

            .payment-options-group h3 {
                color: white;
                font-size: 18px;
                margin-bottom: 15px;
                font-weight: 600;
            }

        .payment-method {
            display: block;
            margin-bottom: 10px;
            padding: 12px 15px;
            border-radius: 10px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

            .payment-method:hover {
                background: rgba(255, 255, 255, 0.2);
            }

            .payment-method input[type="radio"] {
                display: none;
            }

                .payment-method input[type="radio"]:checked + span {
                    border-color: #ff6b9d;
                    background: rgba(255, 107, 157, 0.3);
                    padding: 10px;
                    border-radius: 8px;
                    display: block;
                }

        .payment-method-label {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .payment-info {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 5px;
            padding: 5px 0;
        }
        */

        #paypal-button-container {
            margin-top: 20px;
            display: none; /* Hidden by default */
        }

        /* NEW STYLES: Status Message Modal/Overlay */
        #statusOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9990;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }

            #statusOverlay.visible {
                opacity: 1;
                visibility: visible;
            }

        .status-modal {
            background: linear-gradient(135deg, #ffffff 0%, #f0f0f0 100%);
            border-radius: 20px;
            padding: 40px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            transform: scale(0.8);
            transition: transform 0.3s ease-out;
        }

        #statusOverlay.visible .status-modal {
            transform: scale(1);
        }

        .status-icon {
            font-size: 60px;
            margin-bottom: 20px;
        }

        .status-title {
            font-family: 'Playfair Display', serif;
            font-size: 28px;
            font-weight: 700;
            color: #ff6b9d;
            margin-bottom: 10px;
        }

        .status-message {
            color: #4a5568;
            font-size: 16px;
            margin-bottom: 30px;
        }

        .btn-modal-close {
            padding: 12px 30px;
            background: linear-gradient(135deg, #c471ed, #ff6b9d);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        /*
        ########################################################################################
        ## ESTILOS MEJORADOS/NUEVOS (Fusionados para sobreescribir los originales donde sea necesario)
        ########################################################################################
        */

        /* ===== IMPROVED SELECT STYLES (Overrides original select, input:focus, select:focus) ===== */
        select {
            width: 100%;
            padding: 18px 45px 18px 55px !important;
            background: rgba(255, 255, 255, 0.4) !important;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.5) !important;
            border-radius: 15px;
            color: white !important;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            outline: none;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            cursor: pointer;
            /* Flecha SVG más gruesa y más a la derecha */
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e") !important;
            background-repeat: no-repeat !important;
            background-position: right 20px center !important;
            background-size: 20px !important;
        }

            select option {
                background: #2d3748;
                color: white;
                padding: 15px;
                font-weight: 500;
            }

            select:focus {
                border-color: white !important;
                background: rgba(255, 255, 255, 0.5) !important;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                transform: translateY(-2px);
            }

            select:hover {
                background: rgba(255, 255, 255, 0.45) !important;
                border-color: rgba(255, 255, 255, 0.7);
            }

            /* Custom arrow removed on select with options */
            select[size]:not([size="1"]) {
                background-image: none !important;
            }

        /* IMPROVED INPUT STYLES (Overrides original input, input:focus) */
        input {
            width: 100%;
            padding: 18px 20px 18px 55px;
            background: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.4);
            border-radius: 15px;
            color: white;
            font-size: 16px;
            transition: all 0.3s;
            outline: none;
            font-weight: 500;
        }

            input::placeholder {
                color: rgba(255, 255, 255, 0.7);
            }

            input:focus {
                border-color: white;
                background: rgba(255, 255, 255, 0.4);
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            }

        /* IMPROVED INPUT ICON (Overrides original .input-icon) */
        .input-icon {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 22px; /* Aumentado */
            z-index: 2;
            pointer-events: none;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
        }

        /* ===== IMPROVED PAYMENT RADIO BUTTONS (Overrides original payment-method group) ===== */
        .payment-method {
            display: block;
            margin-bottom: 15px;
            padding: 20px; /* Aumentado */
            border-radius: 15px; /* Aumentado */
            border: 3px solid rgba(255, 255, 255, 0.3); /* Más grueso */
            background: rgba(255, 255, 255, 0.15); /* Ligeramente más claro */
            color: white;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

            .payment-method:hover {
                background: rgba(255, 255, 255, 0.25);
                border-color: rgba(255, 255, 255, 0.5);
                transform: translateY(-2px);
                box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            }

            .payment-method input[type="radio"] {
                position: absolute;
                opacity: 0;
                width: 0;
                height: 0;
            }

                /* Este span ya no se usa como el estilo principal de chequeo en la nueva versión, pero se mantiene */
                .payment-method input[type="radio"]:checked + span {
                    /* Estilo original:
            border-color: #ff6b9d;
            background: rgba(255, 107, 157, 0.3);
            padding: 10px;
            border-radius: 8px;
            display: block;
            */
                    display: block; /* Mantenemos este, aunque el estilo visible es para el contenedor */
                }

            /* NUEVO: Estilo para el contenedor padre cuando el radio está chequeado */
            .payment-method:has(input:checked) {
                border-color: #ff6b9d;
                background: rgba(255, 107, 157, 0.3);
                box-shadow: 0 0 0 3px rgba(255, 107, 157, 0.2);
            }

            .payment-method input[type="radio"]:checked ~ .payment-method-label {
                font-weight: 700; /* Hace que el label chequeado sea más notorio */
            }

        .payment-method-label {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 18px; /* Aumentado */
            margin-bottom: 5px; /* Ajustado */
        }

        .payment-info {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.85); /* Más contraste */
            margin-top: 10px; /* Aumentado */
            padding: 10px;
            background: rgba(0,0,0,0.1); /* Fondo sutil para el detalle */
            border-radius: 8px;
            line-height: 1.5;
        }

        /* IMPROVED GLASS CARD (Overrides original .glass-card) */
        .glass-card {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(30px) saturate(180%);
            border-radius: 40px;
            padding: 50px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            border: 1px solid rgba(255, 255, 255, 0.3);
            animation: fadeInUp 1s ease-out;
            position: relative;
            overflow: hidden; /* Mantenemos las propiedades originales faltantes en el nuevo CSS */
        }

        /* IMPROVED PRICE DETAILS (Overrides original #priceDetails) */
        #priceDetails {
            color: white;
            font-weight: 600;
            margin-bottom: 25px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.2); /* Más brillante */
            border-radius: 15px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            line-height: 1.8;
        }

        /* IMPROVED PAYMENT OPTIONS GROUP (Overrides original .payment-options-group and h3) */
        .payment-options-group {
            margin-top: 25px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

            .payment-options-group h3 {
                color: white;
                font-size: 20px;
                margin-bottom: 20px;
                font-weight: 700;
                text-align: center;
                text-shadow: 0 2px 10px rgba(0,0,0,0.2);
            }

        /* IMPROVED PRIMARY BUTTON (Overrides original .btn-primary) */
        .btn-primary {
            width: 100%;
            padding: 20px; /* Ligeramente más alto */
            background: linear-gradient(135deg, #ff6b9d, #c471ed);
            border: none;
            border-radius: 15px;
            color: white;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 10px 30px rgba(255, 107, 157, 0.4);
            margin-top: 20px; /* Agregado */
        }

            .btn-primary:hover {
                transform: translateY(-3px);
                box-shadow: 0 15px 40px rgba(255, 107, 157, 0.6);
            }

            .btn-primary:disabled {
                opacity: 0.5;
                cursor: not-allowed;
                transform: none;
                box-shadow: none; /* Agregado para mantener el comportamiento original */
            }

        /* IMPROVED PAYPAL BUTTON CONTAINER (Overrides original #paypal-button-container) */
        #paypal-button-container {
            margin-top: 25px; /* Ligeramente más espacio */
            display: none;
            padding: 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
        }
    </style>
</head>
<body>

    <div class="orb orb1"></div>
    <div class="orb orb2"></div>
    <div class="orb orb3"></div>

    <div id="loadingScreen">
        <div class="loading-content">
            <div class="loading-logo">💇‍♀️</div>
            <div class="loading-spinner">
                <div class="spinner-ring"></div>
                <div class="spinner-ring"></div>
                <div class="spinner-ring"></div>
            </div>
            <div class="loading-text">Cargando Sistema<span class="loading-dots"></span></div>
            <div class="loading-subtext">Reservas Premium para Salón de Belleza</div>
        </div>
    </div>

    <div class="container">
        <header class="header">
            <div class="logo-img">💇‍♀️</div>
            <h1 id="mainTitle">Sistema de Reservas</h1>
            <p class="subtitle" id="mainSubtitle">Salón de Belleza</p>
        </header>

        <section id="authScreen" class="auth-container glass-card">
            <div class="auth-tabs">
                <div id="tabLogin" class="auth-tab active">Iniciar Sesión</div>
                <div id="tabRegister" class="auth-tab">Registro</div>
            </div>

            <form id="loginForm" class="auth-form">
                <div class="input-group">
                    <span class="input-icon">📧</span>
                    <input type="email" id="loginEmail" placeholder="Email" required>
                </div>
                <div class="input-group">
                    <span class="input-icon">🔒</span>
                    <input type="password" id="loginPassword" placeholder="Contraseña" required>
                </div>
                <p id="loginMessage" style="color: white; margin-bottom: 15px; text-align: center;"></p>
                <button type="submit" class="btn-primary">Entrar</button>
            </form>

            <form id="registerForm" class="auth-form" style="display: none;">
                <div class="input-group">
                    <span class="input-icon">👤</span>
                    <input type="text" id="registerName" placeholder="Nombre Completo" required>
                </div>
                <div class="input-group">
                    <span class="input-icon">📧</span>
                    <input type="email" id="registerEmail" placeholder="Email" required>
                </div>
                <div class="input-group">
                    <span class="input-icon">📞</span>
                    <input type="tel" id="registerPhone" placeholder="Teléfono" required>
                </div>
                <div class="input-group">
                    <span class="input-icon">🔒</span>
                    <input type="password" id="registerPassword" placeholder="Contraseña" required>
                </div>
                <p id="registerMessage" style="color: white; margin-bottom: 15px; text-align: center;"></p>
                <button type="submit" class="btn-primary">Registrarse</button>
            </form>
        </section>

        <section id="mainAppScreen" style="display: none;">

            <div class="user-nav glass-card">
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar"></div>
                    <div>
                        <span id="userNameDisplay"></span>
                        <p style="font-size: 12px; font-weight: 400; color: rgba(255, 255, 255, 0.7);">Mis citas: <span id="appointmentCountDisplay">0</span></p>
                    </div>
                </div>
                <div class="nav-buttons">
                    <button class="btn-nav active" id="btnNavBook">Reservar</button>
                    <button class="btn-nav" id="btnNavAppointments">Mis Citas</button>
                    <button class="btn-nav" id="btnLogout">Cerrar Sesión</button>
                </div>
            </div>

            <div id="bookingSection" class="glass-card">
                <h2>📅 Nueva Reserva</h2>
                <p class="subtitle" style="margin-bottom: 30px; font-size: 16px;">Selecciona tu servicio, fecha y hora.</p>

                <form id="bookAppointmentForm">
                    <div class="input-group">
                        <span class="input-icon">✂️</span>
                        <select id="serviceKey" required>
                            <option value="">Seleccionar Servicio</option>
                            <option value="corte" data-price="25">Corte de Pelo (45 min) - 25€</option>
                            <option value="tinte" data-price="60">Tinte (120 min) - 60€</option>
                            <option value="mechas" data-price="80">Mechas (150 min) - 80€</option>
                            <option value="peinado" data-price="35">Peinado (60 min) - 35€</option>
                            <option value="tratamiento" data-price="45">Tratamiento Capilar (90 min) - 45€</option>
                            <option value="manicura" data-price="20">Manicura (45 min) - 20€</option>
                        </select>
                    </div>

                    <div class="input-group">
                        <span class="input-icon">📆</span>
                        <input type="date" id="date" required>
                    </div>

                    <div class="input-group">
                        <span class="input-icon">⏰</span>
                        <select id="time" required>
                            <option value="">Seleccionar Hora</option>
                        </select>
                    </div>

                    <div id="priceDetails" style="color: white; font-weight: 600; margin-bottom: 20px; padding: 10px; background: rgba(255, 255, 255, 0.15); border-radius: 10px;">
                        Precio base: <span id="basePrice">0.00</span>€ <span id="discountText" style="color: #38a169; margin-left: 10px;"></span><br>
                        Precio Neto: <span id="netPrice">0.00</span>€
                    </div>

                    <div class="payment-options-group">
                        <h3>Método de Pago 💳</h3>
                        <label class="payment-method">
                            <input type="radio" name="paymentMethod" value="tienda" id="radioTienda" checked>
                            <span class="payment-method-label">
                                <span>💵 Pagar en Tienda</span>
                                <span style="font-size: 16px; font-weight: 700; color: #38a169;">GRATIS</span>
                            </span>
                            <div id="in-store-payment-details" class="payment-info" style="display: block;">
                                Tu reserva será registrada como **Pendiente de Pago** en tienda.
                            </div>
                        </label>
                        <label class="payment-method">
                            <input type="radio" name="paymentMethod" value="paypal" id="radioPaypal">
                            <span class="payment-method-label">
                                <span>💳 PayPal</span>
                                <span id="paypalGrossPriceDisplay" style="font-size: 16px; font-weight: 700; color: #4facfe;">0.00€</span>
                            </span>
                            <div id="paypalCommissionInfo" class="payment-info" style="display: none;">
                                Incluye comisión de PayPal. Precio base que recibirás: <span id="netPriceForPaypal">0.00</span>€
                            </div>
                        </label>
                    </div>

                    <p id="bookingMessage" style="color: white; margin-bottom: 15px; text-align: center;"></p>

                    <button type="button" class="btn-primary" id="btnBookAppointment">Confirmar Reserva (Pagar en Tienda)</button>

                    <div id="paypal-button-container">
                    </div>

                </form>
            </div>

            <div id="appointmentsSection" class="glass-card" style="display: none;">
                <h2>📋 Mis Citas</h2>
                <p class="subtitle" style="margin-bottom: 30px; font-size: 16px;">Aquí puedes ver todas tus reservas.</p>
                <div id="myAppointmentsList" class="appointment-list">
                    <p style="color: white; text-align: center;">Cargando citas...</p>
                </div>
            </div>

        </section>

    </div>

    <div id="statusOverlay">
        <div class="status-modal">
            <div class="status-icon" id="statusIcon"></div>
            <div class="status-title" id="statusTitle"></div>
            <div class="status-message" id="statusMessage"></div>
            <button class="btn-modal-close" onclick="closeStatusModal()">Entendido</button>
        </div>
    </div>


    <script>
        // --- SERVICE CONFIG (Keep in sync with server) ---
        const services = {
            corte: { name: 'Corte de Pelo', duration: 45, price: 25 },
            tinte: { name: 'Tinte', duration: 120, price: 60 },
            mechas: { name: 'Mechas', duration: 150, price: 80 },
            peinado: { name: 'Peinado', duration: 60, price: 35 },
            tratamiento: { name: 'Tratamiento Capilar', duration: 90, price: 45 },
            manicura: { name: 'Manicura', duration: 45, price: 20 }
        };

        let currentUser = null;
        let finalNetPrice = 0;
        let finalGrossPrice = 0;
        let isRecurring = false;

        // --- DOM Elements (Updated) ---
        const loadingScreen = document.getElementById('loadingScreen');
        const authScreen = document.getElementById('authScreen');
        const mainAppScreen = document.getElementById('mainAppScreen');
        const tabLogin = document.getElementById('tabLogin');
        const tabRegister = document.getElementById('tabRegister');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const bookingSection = document.getElementById('bookingSection');
        const appointmentsSection = document.getElementById('appointmentsSection');
        const btnNavBook = document.getElementById('btnNavBook');
        const btnNavAppointments = document.getElementById('btnNavAppointments');
        const btnLogout = document.getElementById('btnLogout');
        const myAppointmentsList = document.getElementById('myAppointmentsList');
        const serviceKey = document.getElementById('serviceKey');
        const dateInput = document.getElementById('date');
        const timeSelect = document.getElementById('time');
        const basePriceDisplay = document.getElementById('basePrice');
        const netPriceDisplay = document.getElementById('netPrice');
        const discountText = document.getElementById('discountText');
        const bookingMessage = document.getElementById('bookingMessage');
        const btnBookAppointment = document.getElementById('btnBookAppointment');

        // Payment elements
        const radioTienda = document.getElementById('radioTienda');
        const radioPaypal = document.getElementById('radioPaypal');
        const paypalGrossPriceDisplay = document.getElementById('paypalGrossPriceDisplay');
        const paypalCommissionInfo = document.getElementById('paypalCommissionInfo');
        const netPriceForPaypal = document.getElementById('netPriceForPaypal');
        const paypalButtonContainer = document.getElementById('paypal-button-container');
        const inStorePaymentDetails = document.getElementById('in-store-payment-details');

        // Status Modal Elements
        const statusOverlay = document.getElementById('statusOverlay');
        const statusIcon = document.getElementById('statusIcon');
        const statusTitle = document.getElementById('statusTitle');
        const statusMessage = document.getElementById('statusMessage');

        // --- Status Modal Functions (NEW) ---
        function showStatusModal(icon, title, message) {
            statusIcon.textContent = icon;
            statusTitle.textContent = title;
            statusMessage.innerHTML = message;
            statusOverlay.classList.add('visible');
            if (icon === '✅') {
                statusTitle.style.color = '#38a169';
            } else if (icon === '⚠️' || icon === '❌') {
                statusTitle.style.color = '#f56565';
            } else {
                statusTitle.style.color = '#ff6b9d';
            }
        }

        function closeStatusModal() {
            statusOverlay.classList.remove('visible');
        }

        // --- Auth Functions (Updated with Status Modal) ---
        tabLogin.addEventListener('click', () => {
            tabLogin.classList.add('active');
            tabRegister.classList.remove('active');
            loginForm.style.display = 'block';
            registerForm.style.display = 'none';
            document.getElementById('mainTitle').textContent = 'Sistema de Reservas';
        });

        tabRegister.addEventListener('click', () => {
            tabRegister.classList.add('active');
            tabLogin.classList.remove('active');
            loginForm.style.display = 'none';
            registerForm.style.display = 'block';
            document.getElementById('mainTitle').textContent = 'Crear Cuenta';
        });

        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const phone = document.getElementById('registerPhone').value;
            const password = document.getElementById('registerPassword').value;
            const messageElement = document.getElementById('registerMessage');
            messageElement.textContent = 'Registrando...';
            messageElement.style.color = 'yellow';

            try {
                const res = await fetch('/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, email, phone, password })
                });
                const data = await res.json();

                if (data.success) {
                    messageElement.textContent = '✅ ¡Registro exitoso! Por favor, inicia sesión.';
                    messageElement.style.color = '#38a169';

                    // Resetear a la pestaña de login
                    setTimeout(() => {
                        tabLogin.click();
                        document.getElementById('loginEmail').value = email;
                        messageElement.textContent = '';
                        document.getElementById('registerForm').reset();
                    }, 2000);

                    // Mostrar mensaje de "Ha sido registrado"
                    showStatusModal('📝', '¡Ha sido registrado!', `Tu cuenta se ha creado exitosamente. Ahora puedes iniciar sesión.`);

                } else {
                    messageElement.textContent = `❌ ${data.message}`;
                    messageElement.style.color = '#f56565';
                }
            } catch (error) {
                messageElement.textContent = '❌ Error de conexión con el servidor.';
                messageElement.style.color = '#f56565';
            }
        });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const messageElement = document.getElementById('loginMessage');
            messageElement.textContent = 'Iniciando sesión...';
            messageElement.style.color = 'yellow';

            try {
                const res = await fetch('/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                const data = await res.json();

                if (data.success) {
                    localStorage.setItem('userId', data.user.id);
                    currentUser = data.user;
                    messageElement.textContent = '✅ ¡Bienvenido!';
                    messageElement.style.color = '#38a169';
                    setTimeout(showMainApp, 500);
                } else {
                    messageElement.textContent = `❌ ${data.message}`;
                    messageElement.style.color = '#f56565';
                }
            } catch (error) {
                messageElement.textContent = '❌ Error de conexión con el servidor.';
                messageElement.style.color = '#f56565';
            }
        });

        btnLogout.addEventListener('click', () => {
            localStorage.removeItem('userId');
            currentUser = null;
            showAuthScreen();
            showStatusModal('👋', 'Sesión Cerrada', 'Has cerrado sesión exitosamente.');
        });

        function showAuthScreen() {
            authScreen.style.display = 'block';
            mainAppScreen.style.display = 'none';
            document.getElementById('mainTitle').textContent = 'Sistema de Reservas';
            document.getElementById('mainSubtitle').textContent = 'Salón de Belleza';
        }

        function showMainApp() {
            // Update UI with user info
            document.getElementById('userNameDisplay').textContent = currentUser.name;
            document.getElementById('userAvatar').textContent = currentUser.name.charAt(0).toUpperCase();
            document.getElementById('appointmentCountDisplay').textContent = currentUser.appointmentCount;

            // Set recurring status
            isRecurring = currentUser.appointmentCount > 0;

            // Show main screen
            authScreen.style.display = 'none';
            mainAppScreen.style.display = 'block';
            document.getElementById('mainTitle').textContent = 'Bienvenido, ' + currentUser.name.split(' ')[0];
            document.getElementById('mainSubtitle').textContent = 'Reserva tu próximo servicio';

            // Hide loading screen
            loadingScreen.classList.add('hidden');

            // Default view to Booking
            showBookingSection();
            updatePriceDetails(); // Also renders PayPal button
        }

        // --- Navigation Functions ---
        btnNavBook.addEventListener('click', showBookingSection);
        btnNavAppointments.addEventListener('click', showAppointmentsSection);

        function showBookingSection() {
            bookingSection.style.display = 'block';
            appointmentsSection.style.display = 'none';
            btnNavBook.classList.add('active');
            btnNavAppointments.classList.remove('active');
        }

        async function showAppointmentsSection() {
            bookingSection.style.display = 'none';
            appointmentsSection.style.display = 'block';
            btnNavBook.classList.remove('active');
            btnNavAppointments.classList.add('active');

            await fetchAppointments();
        }

        // --- Appointment Functions ---
        async function fetchAppointments() {
            myAppointmentsList.innerHTML = '<p style="color: white; text-align: center;">Cargando citas...</p>';

            try {
                const res = await fetch(`/appointments/${currentUser.id}`);
                const data = await res.json();

                if (data.success && data.appointments) {
                    renderAppointments(data.appointments);
                } else {
                    myAppointmentsList.innerHTML = `<p style="color: white; text-align: center;">${data.message || 'Error al cargar citas.'}</p>`;
                }
            } catch (error) {
                myAppointmentsList.innerHTML = '<p style="color: #f56565; text-align: center;">Error de conexión con el servidor.</p>';
            }
        }

        function renderAppointments(appointments) {
            if (appointments.length === 0) {
                myAppointmentsList.innerHTML = '<p style="color: white; text-align: center;">No tienes citas programadas. ¡Reserva una!</p>';
                return;
            }

            myAppointmentsList.innerHTML = appointments.map(apt => {
                const isCompleted = apt.status === 'Completado';
                const statusClass = isCompleted ? 'status-confirmed' : 'status-pending';
                const statusText = apt.status === 'Completado' ? 'Pago Completado' : apt.status === 'Pendiente' ? 'Pendiente de Pago en Tienda' : apt.status;
                const priceText = apt.paymentMethod === 'Tienda' ? `${parseFloat(apt.price).toFixed(2)}€` : `${parseFloat(apt.price).toFixed(2)}€ (Costo Bruto PayPal)`;

                return `
                    <div class="appointment-card">
                        <div class="appointment-header">
                            <div class="appointment-service">${apt.service}</div>
                            <div class="appointment-status ${statusClass}">${statusText}</div>
                        </div>
                        <div class="appointment-details">
                            📅 ${apt.date} a las ${apt.time}<br>
                            ⏱️ ${apt.duration} minutos<br>
                            💰 ${priceText}<br>
                            💳 Método: ${apt.paymentMethod}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // --- Booking Form Logic ---

        // Update Time Slots (UNCHANGED LOGIC)
        dateInput.addEventListener('change', updateTimeSlots);
        serviceKey.addEventListener('change', () => {
            updateTimeSlots();
            updatePriceDetails();
        });

        function updateTimeSlots() {
            timeSelect.innerHTML = '<option value="">Seleccionar Hora</option>';
            const selectedDate = dateInput.value;
            const selectedService = serviceKey.value;

            if (selectedDate && selectedService) {
                // Lógica de slots (debe ser reemplazada por una llamada al servidor para disponibilidad real)
                const slots = ['10:00', '11:00', '12:00', '16:00', '17:00', '18:00'];
                slots.forEach(slot => {
                    const option = document.createElement('option');
                    option.value = slot;
                    option.textContent = slot;
                    timeSelect.appendChild(option);
                });
            }
        }

        // Update Price Details and PayPal Commission (UPDATED)
        serviceKey.addEventListener('change', updatePriceDetails);

        async function updatePriceDetails() {
            const selectedServiceKey = serviceKey.value;
            const service = services[selectedServiceKey];

            if (!service) {
                basePriceDisplay.textContent = '0.00';
                netPriceDisplay.textContent = '0.00';
                discountText.textContent = '';
                finalNetPrice = 0;
                paypalGrossPriceDisplay.textContent = '0.00€';
                renderPayPalButton(); // Clear button
                return;
            }

            let price = service.price;
            let netPriceCalc = price;

            // Apply discount if recurring user (isRecurring is set in showMainApp)
            if (isRecurring) {
                netPriceCalc -= 2;
                discountText.textContent = '(¡-2.00€ Descuento Cliente Fiel!)';
            } else {
                discountText.textContent = '';
            }

            finalNetPrice = netPriceCalc;

            basePriceDisplay.textContent = price.toFixed(2);
            netPriceDisplay.textContent = finalNetPrice.toFixed(2);

            // Calculate PayPal Gross Price
            try {
                const res = await fetch('/api/paypal/calculate-gross-price', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ netPrice: finalNetPrice })
                });
                const data = await res.json();

                if (data.success) {
                    finalGrossPrice = parseFloat(data.grossPrice);
                    paypalGrossPriceDisplay.textContent = `${data.grossPrice}€`;
                    netPriceForPaypal.textContent = `${data.netPrice}€`;
                    paypalCommissionInfo.style.display = 'block';
                } else {
                    console.error('Error calculando comisión de PayPal:', data.message);
                    paypalGrossPriceDisplay.textContent = 'Error';
                    paypalCommissionInfo.style.display = 'none';
                }
            } catch (error) {
                console.error('Error de red al calcular comisión de PayPal:', error);
                paypalGrossPriceDisplay.textContent = 'Error';
                paypalCommissionInfo.style.display = 'none';
            }

            // Re-render PayPal button with new price
            renderPayPalButton();
        }

        // Handle payment method change (UPDATED)
        radioTienda.addEventListener('change', () => {
            btnBookAppointment.style.display = 'block';
            btnBookAppointment.textContent = 'Confirmar Reserva (Pagar en Tienda)';
            paypalButtonContainer.style.display = 'none';
            inStorePaymentDetails.style.display = 'block';
            paypalCommissionInfo.style.display = 'none';
            bookingMessage.textContent = 'Tu reserva será registrada como pendiente de pago.';
            bookingMessage.style.color = 'white';
        });

        radioPaypal.addEventListener('change', () => {
            btnBookAppointment.style.display = 'none';
            paypalButtonContainer.style.display = 'block';
            inStorePaymentDetails.style.display = 'none';
            if(finalNetPrice > 0) paypalCommissionInfo.style.display = 'block';

            bookingMessage.textContent = 'El pago se procesará a través de PayPal al precio indicado.';
            bookingMessage.style.color = 'white';

            // Ensure PayPal button is rendered/updated
            renderPayPalButton();
        });

        // Main booking button listener (Now only for Tienda)
        btnBookAppointment.addEventListener('click', handleBooking);

        async function handleBooking() {
            const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;

            if (paymentMethod === 'tienda') {
                await bookAppointmentTienda();
            }
        }

        async function bookAppointmentTienda() {
            const serviceKeyVal = serviceKey.value;
            const dateVal = dateInput.value;
            const timeVal = timeSelect.value;

            if (!serviceKeyVal || !dateVal || !timeVal) {
                bookingMessage.textContent = '⚠️ Por favor, selecciona servicio, fecha y hora.';
                bookingMessage.style.color = '#f59e0b';
                return;
            }

            bookingMessage.textContent = 'Procesando reserva con pago en tienda...';
            bookingMessage.style.color = 'yellow';
            btnBookAppointment.disabled = true;

            try {
                const res = await fetch('/appointments', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: currentUser.id,
                        serviceKey: serviceKeyVal,
                        date: dateVal,
                        time: timeVal,
                        isRecurring: isRecurring,
                    })
                });
                const data = await res.json();

                if (data.success) {
                    showStatusModal(
                        '📝',
                        '¡Reserva Registrada!',
                        `Tu cita para **${services[serviceKeyVal].name}** ha sido registrada exitosamente.
                        <br>
                        El pago de **${finalNetPrice.toFixed(2)}€** se realizará directamente **en la tienda** el día de tu cita.
                        <br>
                        Revisa tu email para la confirmación.
                        `
                    );
                    // Clear form and update user data
                    document.getElementById('bookAppointmentForm').reset();
                    updatePriceDetails();
                    currentUser.appointmentCount++;
                    showMainApp(); // Refresh user info
                } else {
                    showStatusModal('❌', 'Error al Reservar', data.message || 'Error desconocido al crear la cita.');
                }
            } catch (error) {
                showStatusModal('❌', 'Error de Conexión', 'No se pudo conectar con el servidor para procesar la reserva.');
            } finally {
                btnBookAppointment.disabled = false;
                bookingMessage.textContent = '';
            }
        }

        // --- PayPal Integration (NEW) ---

        function renderPayPalButton() {
            // Clear previous buttons
            paypalButtonContainer.innerHTML = '';

            // Only render if PayPal is selected and we have a valid price
            if (radioPaypal.checked && finalGrossPrice > 0) {
                paypal.Buttons({
                    style: {
                        shape: 'pill',
                        layout: 'vertical',
                        color: 'gold',
                        label: 'pay'
                    },

                    // 1. Set up the transaction (call server to create order)
                    createOrder: function(data, actions) {
                        bookingMessage.textContent = 'Creando orden de pago con PayPal...';
                        bookingMessage.style.color = 'yellow';

                        const serviceKeyVal = serviceKey.value;
                        const service = services[serviceKeyVal];

                        // Call server to create PayPal order (using Gross Price)
                        return fetch('/api/paypal/create-order', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                grossPrice: finalGrossPrice.toFixed(2), // Gross Price with commission
                                serviceName: service ? service.name : 'Reserva de Servicio'
                            })
                        })
                        .then(response => response.json())
                        .then(orderData => {
                            if (orderData.success) {
                                return orderData.orderID;
                            } else {
                                throw new Error(orderData.message);
                            }
                        })
                        .catch(error => {
                            bookingMessage.textContent = `❌ Error en PayPal: ${error.message}`;
                            bookingMessage.style.color = '#f56565';
                            // Propagate error to PayPal SDK
                            return actions.reject(error);
                        });
                    },

                    // 2. Finalize the transaction (call server to capture payment and process booking)
                    onApprove: function(data, actions) {
                        bookingMessage.textContent = 'Capturando pago y confirmando reserva...';
                        bookingMessage.style.color = 'yellow';

                        const serviceKeyVal = serviceKey.value;
                        const dateVal = dateInput.value;
                        const timeVal = timeSelect.value;

                        if (!serviceKeyVal || !dateVal || !timeVal) {
                            showStatusModal('❌', 'Error de Reserva', 'Faltan datos de la reserva. Contacta con soporte.');
                            bookingMessage.textContent = '';
                            return;
                        }

                        // Call server to capture PayPal payment and process booking
                        return fetch('/api/paypal/capture-order', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                orderID: data.orderID,
                                userId: currentUser.id,
                                serviceKey: serviceKeyVal,
                                date: dateVal,
                                time: timeVal,
                                isRecurring: isRecurring,
                                netPrice: finalNetPrice // Net price needed for server's commission check
                            })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                showStatusModal(
                                    '✅',
                                    '¡Pago Completado!',
                                    `Tu reserva para **${services[serviceKeyVal].name}** ha sido pagada y confirmada con éxito.
                                    <br>
                                    El cargo total fue de **${finalGrossPrice.toFixed(2)}€**.
                                    <br>
                                    Revisa tu email para la confirmación.
                                    `
                                );
                                // Clear form and update user data
                                document.getElementById('bookAppointmentForm').reset();
                                updatePriceDetails();
                                currentUser.appointmentCount++;
                                showMainApp(); // Refresh user info
                            } else {
                                showStatusModal('❌', 'Error de Pago', data.message || 'Error desconocido al confirmar el pago.');
                            }
                            bookingMessage.textContent = '';
                        })
                        .catch(error => {
                            showStatusModal('❌', 'Error de Red/Servidor', 'Ocurrió un error en el servidor al confirmar el pago. Por favor, revisa tu cuenta de PayPal.');
                            bookingMessage.textContent = '';
                            console.error('Capture Error:', error);
                        });
                    },

                    // Handle cancellation
                    onCancel: function (data) {
                        bookingMessage.textContent = 'Pago cancelado por el usuario.';
                        bookingMessage.style.color = '#f59e0b';
                    },

                    // Handle error
                    onError: function (err) {
                        showStatusModal('❌', 'Error de PayPal', `Ocurrió un error con el proceso de pago. (${err.message || ''})`);
                        bookingMessage.textContent = '';
                        console.error('PayPal Error:', err);
                    }
                }).render('#paypal-button-container');
            } else if (radioPaypal.checked) {
                // If PayPal is checked but price is 0 or no service selected
                paypalButtonContainer.innerHTML = '<p style="color:white; text-align:center;">Selecciona un servicio y fecha/hora para habilitar el pago.</p>';
            }
        }

        // Listen for booking form changes to re-render the button/price
        document.getElementById('bookAppointmentForm').addEventListener('change', (event) => {
             // Only force re-render if a key field changes
             if (event.target.id === 'serviceKey' || event.target.id === 'date' || event.target.id === 'time' || event.target.name === 'paymentMethod') {
                updatePriceDetails(); // This triggers renderPayPalButton() implicitly
            }
        });


        // AUTO LOGIN IF TOKEN EXISTS
        window.addEventListener('load', async () => {
            const userId = localStorage.getItem('userId');

            if (userId) {
                try {
                    const res = await fetch(`/auth/user/${userId}`);
                    const data = await res.json();

                    if (data.success) {
                        currentUser = data.user;
                        showMainApp();
                    } else {
                        localStorage.removeItem('userId');
                        loadingScreen.classList.add('hidden');
                    }
                } catch (error) {
                    localStorage.removeItem('userId');
                    loadingScreen.classList.add('hidden');
                }
            } else {
                loadingScreen.classList.add('hidden');
            }

            // Set minimum date
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date').setAttribute('min', today);

            // Set initial state for payment
            radioTienda.checked = true;
            document.getElementById('btnBookAppointment').style.display = 'block';
            inStorePaymentDetails.style.display = 'block';
            paypalButtonContainer.style.display = 'none';
        });
    </script>
</body>
</html>